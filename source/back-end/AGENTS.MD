# ü§ñ AGENTS.MD - Boas Pr√°ticas para Agentes IA

## üìã Vis√£o Geral

Este documento define as boas pr√°ticas e padr√µes arquiteturais para agentes IA trabalharem no projeto **BS-Beauty Backend**. Siga estas diretrizes para manter consist√™ncia, qualidade e ader√™ncia aos padr√µes estabelecidos.

---

## üèóÔ∏è Arquitetura do Projeto

### Estrutura de Camadas
```
src/
‚îú‚îÄ‚îÄ controllers/        # Camada de apresenta√ß√£o (HTTP handlers)
‚îú‚îÄ‚îÄ services/          # Camada de neg√≥cio (Use Cases)
‚îú‚îÄ‚îÄ repository/        # Camada de dados (Repository Pattern)
‚îú‚îÄ‚îÄ factory/           # Inje√ß√£o de depend√™ncias
‚îú‚îÄ‚îÄ router/            # Roteamento e middlewares
‚îú‚îÄ‚îÄ middlewares/       # Valida√ß√µes e autentica√ß√£o
‚îú‚îÄ‚îÄ utils/             # Utilit√°rios e helpers
‚îú‚îÄ‚îÄ types/             # Defini√ß√µes de tipos TypeScript
‚îî‚îÄ‚îÄ tests/             # Testes unit√°rios e de integra√ß√£o
```

### Padr√µes Arquiteturais Utilizados
- **Repository Pattern** - Abstra√ß√£o da camada de dados
- **Use Case Pattern** - Encapsulamento de regras de neg√≥cio
- **Factory Pattern** - Cria√ß√£o e inje√ß√£o de depend√™ncias
- **Controller Pattern** - Manipula√ß√£o de requisi√ß√µes HTTP
- **Middleware Pattern** - Valida√ß√µes e autentica√ß√£o

---

## üõ†Ô∏è Diretrizes para Implementa√ß√£o

### 1. **Cria√ß√£o de Nova Entidade**

#### Ordem de Implementa√ß√£o:
1. **Schema Prisma** (se necess√°rio)
2. **Repository** (Interface + Implementa√ß√£o)
3. **Use Case** (Regras de neg√≥cio)
4. **Controller** (Endpoints HTTP)
5. **Factory** (Inje√ß√£o de depend√™ncias)
6. **Routes** (Configura√ß√£o de rotas)
7. **Middlewares** (Valida√ß√µes)
8. **Testes** (Unit√°rios e de integra√ß√£o)

#### Template de Repository:
```typescript
// protocols/entity.repository.ts
interface EntityRepository {
  findAll: () => Promise<Entity[]>
  findById: (id: string) => Promise<Entity | null>
  create: (data: Prisma.EntityCreateInput) => Promise<Entity>
  update: (id: string, data: Prisma.EntityUpdateInput) => Promise<Entity>
  delete: (id: string) => Promise<Entity>
}

// prisma/prisma-entity.repository.ts
class PrismaEntityRepository implements EntityRepository {
  public async findAll() {
    return await prismaClient.entity.findMany()
  }
  // ... outras implementa√ß√µes
}
```

#### Template de Use Case:
```typescript
class EntityUseCase {
  private readonly entityName = 'Entity'

  constructor(private readonly entityRepository: EntityRepository) {}

  public async executeFindAll(): Promise<{ entities: Entity[] }> {
    const entities = await this.entityRepository.findAll()
    return { entities }
  }

  public async executeCreate(data: Prisma.EntityCreateInput): Promise<Entity> {
    // Valida√ß√µes de neg√≥cio aqui
    return await this.entityRepository.create(data)
  }
}
```

### 2. **Nomenclatura e Conven√ß√µes**

#### Arquivos:
- **Controllers:** `entities.controller.ts`
- **Use Cases:** `entities.use-case.ts`
- **Repositories:** `entity.repository.ts` (protocol), `prisma-entity.repository.ts` (implementa√ß√£o)
- **Routes:** `entities.routes.ts`
- **Middlewares:** `action-entity.validation.middleware.ts`
- **Tests:** `entities.use-case.spec.ts`

#### Classes e M√©todos:
- **Controllers:** `EntitiesController` com m√©todos est√°ticos `handleAction`
- **Use Cases:** `EntityUseCase` com m√©todos `executeAction`
- **Repositories:** `EntityRepository` (interface), `PrismaEntityRepository` (implementa√ß√£o)

#### Vari√°veis:
- Use `camelCase` para vari√°veis e m√©todos
- Use `PascalCase` para classes e interfaces
- Use nomes descritivos e espec√≠ficos

### 3. **Coment√°rios no C√≥digo**

#### ‚úÖ **Coment√°rios √öteis:**
```typescript
// Aplica desconto para compras acima de R$ 100
if (totalValue > 100) {
  totalValue *= 0.9
}

// TODO: Implementar cache para melhorar performance
const result = await this.repository.findAll()
```

#### ‚ùå **Coment√°rios Desnecess√°rios:**
```typescript
// ‚ùå MAU - Redundante com requisitos
it('should create role successfully (CA-1)', async () => {
  // ...
})

// ‚ùå MAU - √ìbvio demais
const user = await this.userRepository.findById(id) // Busca usu√°rio por ID

// ‚ùå MAU - Indica√ß√£o de requisito funcional
public async executeCreate(data: CreateRoleInput): Promise<Role> { // RF-1
  // ...
}
```

#### ‚úÖ **Coment√°rios Apropriados:**
```typescript
// ‚úÖ BOM - Explica l√≥gica de neg√≥cio complexa
// Aplica desconto progressivo baseado no volume de compras
if (quantity >= 10) {
  discount = 0.15
} else if (quantity >= 5) {
  discount = 0.1
}

// ‚úÖ BOM - Documenta decis√µes t√©cnicas importantes
// Usando transa√ß√£o para garantir consist√™ncia entre Role e RolePermission
await prismaClient.$transaction(async (tx) => {
  // ...
})
```

### 4. **Valida√ß√£o e Tratamento de Erros**

#### Schemas Zod:
```typescript
class EntitySchemas {
  public static createSchema = z.object({
    name: z.string().min(2).max(50),
    description: z.string().max(500).optional(),
    isActive: z.boolean().optional().default(true)
  }).strict()

  public static updateSchema = z.object({
    name: z.string().min(2).max(50).optional(),
    // ... campos opcionais para update
  }).strict()
}
```

#### Middlewares de Valida√ß√£o:
```typescript
const validateCreateEntity = async (req: Request, res: Response, next: NextFunction): Promise<void> => {
  try {
    EntitySchemas.createSchema.parse(req.body)
    next()
  } catch (error) {
    if (error instanceof z.ZodError) {
      formatValidationErrors(error, res)
      return
    }
    next(error)
  }
}
```

#### Tratamento de Erros:
- Use `RecordExistence.validateRecordExistence()` para verificar exist√™ncia
- Use `RecordExistence.validateRecordNonExistence()` para validar unicidade
- Use `CustomError` para erros personalizados
- Para `findAll()`, retorne arrays vazios em vez de erros
- **Sempre use mensagens de erro em ingl√™s** para consist√™ncia internacional

### 5. **Testes**

#### Estrutura de Testes:
```typescript
describe('EntityUseCase (Unit Tests)', () => {
  let entityUseCase: EntityUseCase

  beforeEach(() => {
    entityUseCase = new EntityUseCase(MockEntityRepository)
    vi.clearAllMocks()
  })

  describe('executeCreate', () => {
    it('should create entity successfully', async () => {
      // Arrange
      const entityData = { /* dados v√°lidos */ }
      MockEntityRepository.create.mockResolvedValue(expectedEntity)
      
      // Act
      const result = await entityUseCase.executeCreate(entityData)
      
      // Assert
      expect(result).toEqual(expectedEntity)
      expect(MockEntityRepository.create).toHaveBeenCalledWith(entityData)
    })
  })
})
```

#### Coverage de Testes:
- **Use Cases:** Teste todos os m√©todos e cen√°rios de erro
- **Middlewares:** Teste valida√ß√µes v√°lidas e inv√°lidas
- **Repositories:** Teste principalmente via integration tests

### 6. **Valida√ß√£o de Qualidade de C√≥digo**

#### Comandos Obrigat√≥rios antes de Finalizar:
```bash
# 1. Verificar todos os testes unit√°rios
npm run test:unit

# 2. Verificar lint (padr√µes de c√≥digo)
npm run lint

# 3. Corrigir problemas de lint automaticamente (se necess√°rio)
npm run lint:fix

# 4. Validar TypeScript (verificar erros de tipos)
npx tsc --noEmit
```

#### ‚ö†Ô∏è **Regra Importante:**
- **NUNCA** finalize uma implementa√ß√£o sem que todos esses comandos passem sem erros
- Se houver erros de lint, corrija-os antes de continuar
- Se houver erros do TypeScript, resolva-os obrigatoriamente
- Todos os testes devem estar passando (100% success rate)

#### ü§ñ **Auto-Valida√ß√£o para Agentes IA:**
Antes de finalizar qualquer implementa√ß√£o, execute este checklist:
```bash
# 1. Verificar coment√°rios desnecess√°rios
grep -r "(RF-\|CA-\|RN-)" src/ --include="*.ts" --exclude-dir=node_modules
# Se encontrar resultados, remova os coment√°rios

# 2. Verificar mensagens em portugu√™s
grep -r "n√£o\|N√£o\|√©\|ser\|para" src/ --include="*.ts" --exclude-dir=node_modules | grep -i error
# Se encontrar mensagens de erro em portugu√™s, traduza para ingl√™s

# 3. Executar valida√ß√µes obrigat√≥rias
npm run test:unit
npm run lint
npx tsc --noEmit
```

---

## üìã Checklist para Nova Feature

### ‚úÖ **Antes de Come√ßar:**
- [ ] Entenda os requisitos funcionais (RF) e regras de neg√≥cio (RN)
- [ ] Identifique crit√©rios de aceita√ß√£o (CA)
- [ ] Verifique se a entidade j√° existe no schema Prisma
- [ ] Analise depend√™ncias com outras entidades

### ‚úÖ **Durante a Implementa√ß√£o:**
- [ ] Siga a ordem: Repository ‚Üí Use Case ‚Üí Controller ‚Üí Factory ‚Üí Routes ‚Üí Middlewares ‚Üí Tests
- [ ] Use os padr√µes de nomenclatura estabelecidos
- [ ] Implemente valida√ß√µes de neg√≥cio nos Use Cases
- [ ] Adicione middlewares de valida√ß√£o Zod
- [ ] Configure autentica√ß√£o apropriada nas rotas
- [ ] Escreva testes para cada componente

### ‚úÖ **Antes de Finalizar:**
- [ ] Execute todos os testes: `npm run test:unit`
- [ ] Verifique lint: `npm run lint` (corrija com `npm run lint:fix` se necess√°rio)
- [ ] Valide TypeScript: `npx tsc --noEmit` (garante que n√£o h√° erros de tipos)
- [ ] Teste endpoints manualmente (se poss√≠vel)
- [ ] Documente mudan√ßas significativas
- [ ] Valide que todos os CAs foram atendidos

---

## üîß Comandos √öteis

### Desenvolvimento:
```bash
npm run start:dev          # Servidor de desenvolvimento
npm run build             # Build para produ√ß√£o
npm run lint              # Verificar c√≥digo
npm run lint:fix          # Corrigir problemas de lint
```

### Testes:
```bash
npm run test:unit          # Testes unit√°rios
npm run test:unit:watch    # Testes em modo watch
npm run test:int           # Testes de integra√ß√£o
npm run coverage:unit      # Coverage dos testes unit√°rios
```

### Valida√ß√£o de C√≥digo:
```bash
npx tsc --noEmit          # Verificar erros de TypeScript
npm run lint              # Verificar padr√µes ESLint
npm run lint:fix          # Corrigir automaticamente problemas de ESLint
```

---

## üö´ **O que N√ÉO fazer**

### ‚ùå **M√°s Pr√°ticas:**
- **N√ÉO** coloque l√≥gica de neg√≥cio nos Controllers
- **N√ÉO** acesse o banco diretamente nos Controllers
- **N√ÉO** misture responsabilidades entre camadas
- **N√ÉO** esque√ßa de adicionar valida√ß√µes de entrada
- **N√ÉO** implemente sem testes
- **N√ÉO** quebre conven√ß√µes de nomenclatura
- **N√ÉO** ignore tratamento de erros
- **N√ÉO** fa√ßa commits sem executar testes
- **N√ÉO** duplique c√≥digo - sempre aplique o princ√≠pio DRY (Don't Repeat Yourself)

### ‚ùå **Erros Comuns:**
- N√£o adicionar newline no final dos arquivos
- Usar imports relativos em vez do path mapping (`@/`)
- Esquecer de exportar classes/interfaces
- N√£o mockar depend√™ncias nos testes
- N√£o seguir o padr√£o strict do Zod (`.strict()`)
- **Duplicar l√≥gica entre m√©todos** - sempre extrair c√≥digo comum
- Criar m√©todos redundantes quando um pode servir ambos os prop√≥sitos
- **Adicionar coment√°rios desnecess√°rios** - evite coment√°rios indicando RF, CA, RN no c√≥digo
- **Usar mensagens de erro em portugu√™s** - sempre use ingl√™s para mensagens de erro

### üîÑ **Princ√≠pio DRY:**
```typescript
// ‚ùå MAU - C√≥digo duplicado
public async executeFindAll(): Promise<RolesOutput> {
  const roles = await this.roleRepository.findAll()
  return { roles }
}

public async executeFindAllPaginated(params: PaginatedRequest<RoleFilters>): Promise<PaginatedResult<Role>> {
  const result = await this.roleRepository.findAllPaginated(params)
  return result
}

// ‚úÖ BOM - Reutilizar c√≥digo
public async executeFindAll(): Promise<RolesOutput> {
  const result = await this.executeFindAllPaginated({
    page: 1,
    limit: 1000, // ou Number.MAX_SAFE_INTEGER para todos
    filters: {}
  })
  return { roles: result.data }
}
```

---

## üìö **Recursos Adicionais**

### Tecnologias Principais:
- **Node.js + TypeScript** - Runtime e linguagem
- **Express.js** - Framework web
- **Prisma** - ORM e gerenciamento de banco
- **Zod** - Valida√ß√£o de esquemas
- **Vitest** - Framework de testes
- **JWT** - Autentica√ß√£o

### Documenta√ß√£o de Refer√™ncia:
- [Prisma Docs](https://www.prisma.io/docs)
- [Zod Documentation](https://zod.dev)
- [Vitest Guide](https://vitest.dev/guide/)
- [Express.js Guide](https://expressjs.com/en/guide/)

---

## üéØ **Objetivo Final**

Manter um codebase **consistente**, **test√°vel**, **escal√°vel** e **manuten√≠vel**, seguindo princ√≠pios SOLID e padr√µes arquiteturais bem estabelecidos. Cada nova feature deve integrar-se harmoniosamente com o ecossistema existente.

---

**√öltima atualiza√ß√£o:** Setembro 2025  
**Vers√£o:** 1.0  
**Projeto:** BS-Beauty Backend